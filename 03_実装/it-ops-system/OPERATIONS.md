# 運用・保守マニュアル

## 監視体制

### システム監視項目

#### インフラストラクチャ監視
- CPU使用率: 80%以上でアラート
- メモリ使用率: 85%以上でアラート
- ディスク使用率: 90%以上でアラート
- ネットワークトラフィック: 帯域の70%以上で警告

#### アプリケーション監視
- レスポンスタイム: 3秒以上で警告
- エラーレート: 1分間で5%以上でアラート
- アクティブユーザー数
- API呼び出し頻度

#### セキュリティ監視
- 不正アクセス試行
- 異常なトラフィックパターン
- 認証失敗回数
- セキュリティパッチ状況

### モニタリングツール設定

#### Prometheus設定
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'backend'
    static_configs:
      - targets: ['backend:3000']
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

#### Grafanaダッシュボード
- システムメトリクス
- アプリケーションメトリクス
- セキュリティメトリクス
- カスタムアラート

## インシデント対応

### 重要度レベル定義
1. クリティカル
   - システム全体の停止
   - データ損失のリスク
   - セキュリティ侵害
2. 重度
   - 主要機能の停止
   - パフォーマンス深刻劣化
3. 中度
   - 一部機能の停止
   - パフォーマンス軽度劣化
4. 軽度
   - 表示の乱れ
   - 軽微な機能不全

### インシデント対応フロー

1. 検知
   ```
   アラート受信 → 影響度判定 → 担当者アサイン
   ```

2. 初期対応
   ```
   状況確認 → 一時対策実施 → 利用者通知
   ```

3. 原因究明
   ```
   ログ分析 → 影響範囲特定 → 根本原因特定
   ```

4. 恒久対策
   ```
   対策立案 → 対策実施 → 効果確認
   ```

## 定期メンテナンス

### 日次作業
- ログ確認
- バックアップ確認
- アラート確認
- パフォーマンス確認

### 週次作業
- セキュリティアップデート適用
- リソース使用状況レビュー
- パフォーマンス分析
- バックアップテスト

### 月次作業
- システム全体診断
- セキュリティ診断
- 性能分析レポート作成
- キャパシティプランニング

## バックアップ・リカバリ

### バックアップスケジュール
- フルバックアップ: 週1回
- 差分バックアップ: 毎日
- トランザクションログ: 1時間ごと

### リカバリ手順
1. 障害状況確認
   ```bash
   # システム状態確認
   kubectl get pods,services
   # ログ確認
   kubectl logs -l app=backend
   ```

2. バックアップからの復旧
   ```bash
   # 最新のバックアップを特定
   ls -l /backup/
   # リストア実行
   mongorestore --uri $MONGODB_URI /backup/latest/
   ```

## セキュリティ運用

### 定期的なセキュリティタスク
- 脆弱性スキャン実施
- セキュリティパッチ適用
- アクセスログ監査
- セキュリティポリシーレビュー

### インシデント対応
1. 検知と通知
   - IDS/IPSアラート
   - WAFアラート
   - 異常アクセス検知

2. 調査と対応
   - アクセスログ分析
   - 攻撃元IPのブロック
   - 影響範囲の特定

3. 復旧と再発防止
   - システム復旧
   - セキュリティ対策強化
   - 監視ルール更新

## パフォーマンスチューニング

### 監視指標
- レスポンスタイム
- スループット
- エラーレート
- リソース使用率

### チューニングポイント
```yaml
# Node.js設定
NODE_OPTIONS="--max-old-space-size=4096"
NODE_ENV=production

# MongoDB設定
maxPoolSize: 100
wtimeoutMS: 2500

# Redis設定
maxmemory 2gb
maxmemory-policy allkeys-lru
```

## トラブルシューティング

### 一般的な問題と解決策

1. 高負荷時の対応
   ```bash
   # 負荷状況確認
   top
   htop
   # スケールアウト
   kubectl scale deployment backend --replicas=5
   ```

2. メモリリーク対応
   ```bash
   # ヒープダンプ取得
   node --heap-prof app.js
   # メモリ使用分析
   node --inspect app.js
   ```

3. ネットワーク問題
   ```bash
   # 接続確認
   netstat -tulpn
   # SSL確認
   openssl s_client -connect host:443
   ```

## 定期レポート

### 週次レポート項目
- システム稼働状況
- インシデント一覧
- パフォーマンス指標
- リソース使用状況

### 月次レポート項目
- SLA達成状況
- セキュリティ状況
- コスト分析
- 改善提案