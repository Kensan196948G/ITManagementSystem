# システムアーキテクチャ設計書

## 概要

本ドキュメントは、IT運用システムのアーキテクチャ設計を定義します。このシステムは、ISO 20000（ITサービスマネジメント）およびISO 27001（情報セキュリティマネジメント）の要件に準拠して設計されています。

## バージョン情報

- ドキュメントバージョン: 1.0.0
- 最終更新日: 2025年3月8日

## システム全体構成

![システム全体構成図](../images/system-architecture.png)

IT運用システムは、以下の主要コンポーネントで構成されています：

1. **フロントエンドアプリケーション**
   - React.jsベースのSPA（Single Page Application）
   - Material UIコンポーネントライブラリ
   - 国際化（i18n）対応
   - アクセシビリティ対応

2. **バックエンドAPI**
   - Node.js + Express.jsフレームワーク
   - RESTful APIアーキテクチャ
   - WebSocket通信（リアルタイム通知）

3. **データストレージ**
   - SQLiteデータベース
   - ファイルストレージ（ログ、設定ファイル）

4. **外部連携**
   - Microsoft Graph API連携
   - PowerShellスクリプト実行

5. **監視・ロギング**
   - 集中ログ管理
   - パフォーマンスモニタリング
   - セキュリティ監視

## コンポーネント詳細

### 1. フロントエンドアプリケーション

#### アーキテクチャパターン

フロントエンドは、以下のアーキテクチャパターンに基づいて設計されています：

- **コンポーネントベースアーキテクチャ**: 再利用可能なUIコンポーネント
- **Flux/Reduxパターン**: 単方向データフロー
- **プレゼンテーション/コンテナパターン**: ロジックとUIの分離

#### 主要モジュール

| モジュール | 説明 | 責務 |
|-----------|------|------|
| AuthModule | 認証・認可 | ユーザー認証、権限管理 |
| DashboardModule | ダッシュボード | システム概要表示 |
| PermissionModule | パーミッション管理 | Graph APIパーミッション管理 |
| SystemStatusModule | システムステータス | リソース使用状況、アラート表示 |
| NotificationModule | 通知 | リアルタイム通知管理 |
| I18nModule | 国際化 | 多言語対応 |
| AccessibilityModule | アクセシビリティ | アクセシビリティ機能 |

#### 技術スタック

- **フレームワーク**: React.js 18.x
- **状態管理**: React Context API
- **UIライブラリ**: Material UI 5.x
- **HTTP通信**: Axios
- **WebSocket**: Native WebSocket API
- **国際化**: React-Intl
- **ビルドツール**: Webpack 5.x

### 2. バックエンドAPI

#### アーキテクチャパターン

バックエンドは、以下のアーキテクチャパターンに基づいて設計されています：

- **レイヤードアーキテクチャ**: ルーター、サービス、データアクセスの分離
- **依存性注入**: サービス間の疎結合
- **リポジトリパターン**: データアクセスの抽象化
- **ミドルウェアパターン**: 横断的関心事の分離

#### 主要モジュール

| モジュール | 説明 | 責務 |
|-----------|------|------|
| AuthService | 認証サービス | ユーザー認証、トークン管理 |
| PermissionService | パーミッション管理 | Graph APIパーミッション操作 |
| GraphPermissionService | Graph API連携 | Microsoft Graph API連携 |
| SystemStatusService | システムステータス | システム状態監視 |
| NotificationService | 通知サービス | WebSocket通知管理 |
| AuditLogService | 監査ログ | 操作ログ記録・検索 |
| CacheService | キャッシュ | データキャッシュ管理 |

#### 技術スタック

- **ランタイム**: Node.js 18.x
- **フレームワーク**: Express.js 4.x
- **データベース**: SQLite 3.x
- **ORM**: カスタムSQLiteラッパー
- **認証**: JWT (JSON Web Token)
- **WebSocket**: ws ライブラリ
- **ロギング**: Winston

### 3. データストレージ

#### データベース設計

主要なデータベーステーブル：

| テーブル名 | 説明 | 主要フィールド |
|-----------|------|--------------|
| users | ユーザー情報 | id, email, name, roles, created_at |
| permissions | パーミッション情報 | id, user_id, permission, scope, created_at |
| audit_logs | 監査ログ | id, user_id, action, resource, timestamp, details |
| security_alerts | セキュリティアラート | id, severity, type, message, status, timestamp |
| system_metrics | システムメトリクス | id, metric_type, value, timestamp |

#### データフロー

1. **認証フロー**:
   - ユーザーログイン → 認証 → JWTトークン発行
   - トークン検証 → 権限チェック → リソースアクセス

2. **パーミッション管理フロー**:
   - パーミッション要求 → 権限チェック → PowerShellスクリプト実行 → 結果返却

3. **監査ログフロー**:
   - 操作実行 → 監査ログ記録 → ログ検索・分析

4. **通知フロー**:
   - イベント発生 → 通知生成 → WebSocket送信 → クライアント表示

### 4. 外部連携

#### Microsoft Graph API連携

- **認証方式**: OAuth 2.0 / Azure AD
- **主要API**:
  - ユーザー管理API
  - パーミッション管理API
  - リソース管理API

#### PowerShellスクリプト実行

- **実行方式**: Node.js child_process
- **主要スクリプト**:
  - パーミッション付与スクリプト
  - パーミッション削除スクリプト
  - システム情報取得スクリプト

### 5. 監視・ロギング

#### ログレベル

| レベル | 説明 | 用途 |
|--------|------|------|
| ERROR | エラー | 例外、障害 |
| WARN | 警告 | 潜在的な問題 |
| INFO | 情報 | 一般的な情報 |
| DEBUG | デバッグ | 開発・トラブルシューティング |
| SECURITY | セキュリティ | セキュリティ関連イベント |

#### 監視対象メトリクス

- **システムメトリクス**: CPU使用率、メモリ使用率、ディスク使用率
- **アプリケーションメトリクス**: レスポンス時間、エラー率、リクエスト数
- **セキュリティメトリクス**: 認証失敗回数、権限違反試行回数

## セキュリティアーキテクチャ

ISO 27001に準拠したセキュリティ対策：

### 1. 認証・認可

- **多要素認証**: 必要に応じてMFA対応
- **ロールベースアクセス制御**: 最小権限の原則に基づく権限設計
- **セッション管理**: 適切なセッションタイムアウト、無効化

### 2. 通信セキュリティ

- **TLS暗号化**: すべての通信をTLS 1.2以上で暗号化
- **証明書管理**: 適切な証明書更新プロセス
- **APIセキュリティ**: レート制限、CORS設定

### 3. データセキュリティ

- **保存データ暗号化**: センシティブデータの暗号化
- **データ分類**: 情報資産の分類と適切な保護
- **データバックアップ**: 定期的なバックアップと復元テスト

### 4. 監査・ログ

- **監査ログ**: すべての重要操作の記録
- **ログ保全**: 改ざん防止対策
- **ログ分析**: 異常検知、セキュリティインシデント検出

### 5. 脆弱性管理

- **セキュアコーディング**: OWASP Top 10対策
- **依存関係管理**: 脆弱性のある依存パッケージの管理
- **セキュリティテスト**: 定期的な脆弱性スキャン

## ITサービスマネジメント統合

ISO 20000に準拠したITSM統合：

### 1. サービスレベル管理

- **SLA監視**: システムパフォーマンスのSLA監視
- **サービスレポート**: 定期的なサービスレポート生成

### 2. インシデント・問題管理

- **アラート連携**: セキュリティアラートのインシデント管理連携
- **根本原因分析**: 問題の根本原因特定支援

### 3. 変更管理

- **変更記録**: パーミッション変更の記録と追跡
- **変更承認**: 重要な変更の承認プロセス

### 4. 構成管理

- **CMDB連携**: システムリソース情報のCMDB連携
- **構成項目追跡**: 構成変更の追跡

### 5. 可用性・キャパシティ管理

- **リソースモニタリング**: システムリソースの監視
- **キャパシティ予測**: 使用傾向分析と予測

## 非機能要件

### 1. パフォーマンス

- **レスポンス時間**: API応答時間 < 500ms（95パーセンタイル）
- **スループット**: 最大100リクエスト/秒
- **同時接続数**: 最大500接続

### 2. スケーラビリティ

- **水平スケーリング**: 負荷に応じたインスタンス追加
- **垂直スケーリング**: リソース割り当て増加

### 3. 可用性

- **稼働率**: 99.9%（月間ダウンタイム < 43分）
- **障害復旧**: RTO < 1時間、RPO < 15分

### 4. 保守性

- **モジュール化**: 高凝集・低結合の設計
- **テスト自動化**: 単体テスト、統合テスト、E2Eテスト
- **CI/CD**: 継続的インテグレーション・デリバリー

## デプロイメントアーキテクチャ

### 開発環境

- **ローカル開発環境**: 開発者PC上での実行
- **テスト環境**: 統合テスト用環境

### 本番環境

- **アプリケーションサーバー**: Node.js実行環境
- **データベースサーバー**: SQLiteファイルストレージ
- **ウェブサーバー**: Nginx（リバースプロキシ）

## 技術的負債と将来の拡張性

### 現在の制約

- SQLiteの同時接続数制限
- 単一サーバーでの実行
- 限定的なGraph API機能サポート

### 将来の拡張計画

- **データベース移行**: SQLite → PostgreSQL
- **マイクロサービス化**: 機能ごとの分割
- **コンテナ化**: Docker/Kubernetes対応
- **クラウド対応**: クラウドネイティブアーキテクチャ

## 参考資料

- ISO/IEC 20000-1:2018 ITサービスマネジメントシステム要求事項
- ISO/IEC 27001:2013 情報セキュリティマネジメントシステム要求事項
- ITIL 4 フレームワーク
- NIST Cybersecurity Framework

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-03-08 | 1.0.0 | 初版リリース |