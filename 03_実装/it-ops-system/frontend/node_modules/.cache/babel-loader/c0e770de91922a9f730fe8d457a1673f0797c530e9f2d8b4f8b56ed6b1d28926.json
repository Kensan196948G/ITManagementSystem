{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Alert,CircularProgress,Container,Typography,List,ListItem,ListItemIcon,ListItemText,Chip}from'@mui/material';import CheckCircleIcon from'@mui/icons-material/CheckCircle';import ErrorIcon from'@mui/icons-material/Error';import{useAuth}from'../../contexts/AuthContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export const GraphAPIPermissionCheck=_ref=>{let{children}=_ref;const{user}=useAuth();const[isAdmin,setIsAdmin]=useState(null);const[error,setError]=useState(null);const[loading,setLoading]=useState(true);const[permissions,setPermissions]=useState(null);const checkAdminStatus=async()=>{try{const response=await fetch('/api/admin/check-global-admin',{headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`}});const data=await response.json();if(data.status==='success'){setIsAdmin(data.isGlobalAdmin);if(data.isGlobalAdmin){await checkGraphPermissions();}}else{setError('管理者権限の確認に失敗しました');}}catch(err){setError('管理者権限の確認中にエラーが発生しました');}finally{setLoading(false);}};useEffect(()=>{checkAdminStatus();},[]);const checkGraphPermissions=async()=>{try{const response=await fetch('/api/admin/graph-permissions',{headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`}});const data=await response.json();if(data.status==='success'){setPermissions(data.data);}else{setError('Graph APIパーミッションの確認に失敗しました');}}catch(err){setError('Graph APIパーミッションの確認中にエラーが発生しました');}};if(loading){return/*#__PURE__*/_jsx(Container,{sx:{display:'flex',justifyContent:'center',mt:4},children:/*#__PURE__*/_jsx(CircularProgress,{})});}if(error){return/*#__PURE__*/_jsx(Alert,{severity:\"error\",sx:{my:2},children:error});}if(!isAdmin){return/*#__PURE__*/_jsx(Alert,{severity:\"warning\",sx:{my:2},children:\"\\u3053\\u306E\\u6A5F\\u80FD\\u3092\\u5229\\u7528\\u3059\\u308B\\u306B\\u306F\\u30B0\\u30ED\\u30FC\\u30D0\\u30EB\\u7BA1\\u7406\\u8005\\u6A29\\u9650\\u304C\\u5FC5\\u8981\\u3067\\u3059\\u3002\"});}const missingPermissions=(permissions===null||permissions===void 0?void 0:permissions.recommendedPermissions.filter(perm=>!permissions.currentPermissions.some(current=>current.resourceAccess.some(access=>access.id===perm))))||[];return/*#__PURE__*/_jsxs(Container,{sx:{maxWidth:800,mx:'auto',p:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",gutterBottom:true,children:\"Microsoft Graph API \\u30D1\\u30FC\\u30DF\\u30C3\\u30B7\\u30E7\\u30F3\\u78BA\\u8A8D\"}),/*#__PURE__*/_jsx(List,{children:permissions===null||permissions===void 0?void 0:permissions.recommendedPermissions.map(permission=>/*#__PURE__*/_jsxs(ListItem,{children:[/*#__PURE__*/_jsx(ListItemIcon,{children:permissions.currentPermissions.some(current=>current.resourceAccess.some(access=>access.id===permission))?/*#__PURE__*/_jsx(CheckCircleIcon,{color:\"success\"}):/*#__PURE__*/_jsx(ErrorIcon,{color:\"error\"})}),/*#__PURE__*/_jsx(ListItemText,{primary:permission,secondary:/*#__PURE__*/_jsx(Chip,{label:permissions.currentPermissions.some(current=>current.resourceAccess.some(access=>access.id===permission))?\"設定済み\":\"未設定\",color:permissions.currentPermissions.some(current=>current.resourceAccess.some(access=>access.id===permission))?\"success\":\"error\",size:\"small\"})})]},permission))}),missingPermissions.length>0&&/*#__PURE__*/_jsxs(Alert,{severity:\"warning\",sx:{mt:2},children:[missingPermissions.length,\"\\u500B\\u306E\\u63A8\\u5968\\u30D1\\u30FC\\u30DF\\u30C3\\u30B7\\u30E7\\u30F3\\u304C\\u672A\\u8A2D\\u5B9A\\u3067\\u3059\"]}),children]});};","map":{"version":3,"names":["React","useEffect","useState","Alert","CircularProgress","Container","Typography","List","ListItem","ListItemIcon","ListItemText","Chip","CheckCircleIcon","ErrorIcon","useAuth","jsx","_jsx","jsxs","_jsxs","GraphAPIPermissionCheck","_ref","children","user","isAdmin","setIsAdmin","error","setError","loading","setLoading","permissions","setPermissions","checkAdminStatus","response","fetch","headers","localStorage","getItem","data","json","status","isGlobalAdmin","checkGraphPermissions","err","sx","display","justifyContent","mt","severity","my","missingPermissions","recommendedPermissions","filter","perm","currentPermissions","some","current","resourceAccess","access","id","maxWidth","mx","p","variant","gutterBottom","map","permission","color","primary","secondary","label","size","length"],"sources":["E:/IT運用システム/03_実装/it-ops-system/frontend/src/components/admin/GraphAPIPermissionCheck.tsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\r\nimport {\r\n  Alert,\r\n  CircularProgress,\r\n  Container,\r\n  Typography,\r\n  List,\r\n  ListItem,\r\n  ListItemIcon,\r\n  ListItemText,\r\n  Chip,\r\n} from '@mui/material';\r\nimport CheckCircleIcon from '@mui/icons-material/CheckCircle';\r\nimport ErrorIcon from '@mui/icons-material/Error';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\n\r\ninterface Permission {\r\n  id: string;\r\n  type: string;\r\n}\r\n\r\ninterface PermissionData {\r\n  recommendedPermissions: string[];\r\n  currentPermissions: {\r\n    resourceAccess: Permission[];\r\n  }[];\r\n}\r\n\r\nexport const GraphAPIPermissionCheck: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const { user } = useAuth();\r\n  const [isAdmin, setIsAdmin] = useState<boolean | null>(null);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [permissions, setPermissions] = useState<PermissionData | null>(null);\r\n\r\n  const checkAdminStatus = async () => {\r\n    try {\r\n      const response = await fetch('/api/admin/check-global-admin', {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      });\r\n      const data = await response.json();\r\n      \r\n      if (data.status === 'success') {\r\n        setIsAdmin(data.isGlobalAdmin);\r\n        if (data.isGlobalAdmin) {\r\n          await checkGraphPermissions();\r\n        }\r\n      } else {\r\n        setError('管理者権限の確認に失敗しました');\r\n      }\r\n    } catch (err) {\r\n      setError('管理者権限の確認中にエラーが発生しました');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    checkAdminStatus();\r\n  }, []);\r\n\r\n  const checkGraphPermissions = async () => {\r\n    try {\r\n      const response = await fetch('/api/admin/graph-permissions', {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      });\r\n      const data = await response.json();\r\n      \r\n      if (data.status === 'success') {\r\n        setPermissions(data.data);\r\n      } else {\r\n        setError('Graph APIパーミッションの確認に失敗しました');\r\n      }\r\n    } catch (err) {\r\n      setError('Graph APIパーミッションの確認中にエラーが発生しました');\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <Container sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>\r\n        <CircularProgress />\r\n      </Container>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <Alert severity=\"error\" sx={{ my: 2 }}>\r\n        {error}\r\n      </Alert>\r\n    );\r\n  }\r\n\r\n  if (!isAdmin) {\r\n    return (\r\n      <Alert severity=\"warning\" sx={{ my: 2 }}>\r\n        この機能を利用するにはグローバル管理者権限が必要です。\r\n      </Alert>\r\n    );\r\n  }\r\n\r\n  const missingPermissions = permissions?.recommendedPermissions.filter(\r\n    (perm: string) => !permissions.currentPermissions.some(\r\n      (current) => current.resourceAccess.some(\r\n        (access) => access.id === perm\r\n      )\r\n    )\r\n  ) || [];\r\n\r\n  return (\r\n    <Container sx={{ maxWidth: 800, mx: 'auto', p: 3 }}>\r\n      <Typography variant=\"h5\" gutterBottom>\r\n        Microsoft Graph API パーミッション確認\r\n      </Typography>\r\n\r\n      <List>\r\n        {permissions?.recommendedPermissions.map((permission: string) => (\r\n          <ListItem key={permission}>\r\n            <ListItemIcon>\r\n              {permissions.currentPermissions.some(\r\n                (current) => current.resourceAccess.some(\r\n                  (access) => access.id === permission\r\n                )\r\n              ) ? (\r\n                <CheckCircleIcon color=\"success\" />\r\n              ) : (\r\n                <ErrorIcon color=\"error\" />\r\n              )}\r\n            </ListItemIcon>\r\n            <ListItemText\r\n              primary={permission}\r\n              secondary={\r\n                <Chip\r\n                  label={\r\n                    permissions.currentPermissions.some(\r\n                      (current) => current.resourceAccess.some(\r\n                        (access) => access.id === permission\r\n                      )\r\n                    )\r\n                      ? \"設定済み\"\r\n                      : \"未設定\"\r\n                  }\r\n                  color={\r\n                    permissions.currentPermissions.some(\r\n                      (current) => current.resourceAccess.some(\r\n                        (access) => access.id === permission\r\n                      )\r\n                    )\r\n                      ? \"success\"\r\n                      : \"error\"\r\n                  }\r\n                  size=\"small\"\r\n                />\r\n              }\r\n            />\r\n          </ListItem>\r\n        ))}\r\n      </List>\r\n\r\n      {missingPermissions.length > 0 && (\r\n        <Alert severity=\"warning\" sx={{ mt: 2 }}>\r\n          {missingPermissions.length}個の推奨パーミッションが未設定です\r\n        </Alert>\r\n      )}\r\n\r\n      {children}\r\n    </Container>\r\n  );\r\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}